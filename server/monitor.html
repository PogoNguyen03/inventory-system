<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>H·ªá th·ªëng Gi√°m s√°t Kho Real-time</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #f0f2f5;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        margin: auto;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      #stock-display {
        font-size: 80px;
        text-align: center;
        color: #2ecc71;
        font-weight: bold;
        margin: 20px 0;
      }
      .log {
        font-size: 14px;
        color: #666;
        border-top: 1px solid #eee;
        padding-top: 10px;
      }
      .blink {
        animation: blinker 1s linear infinite;
        color: red !important;
      }
      @keyframes blinker {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>üì¶ KHO IPHONE 15 PRO</h1>
      <div class="subtitle" style="text-align: center">C·ª≠a h√†ng Qu·∫≠n 1</div>

      <div id="stock-display">--</div>

      <div id="status-log" class="log">ƒêang ch·ªù t√≠n hi·ªáu t·ª´ Server...</div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io("http://localhost:3000");
      const display = document.getElementById("stock-display");
      const statusLog = document.getElementById("status-log");

      // 1. H√†m l·∫•y d·ªØ li·ªáu ban ƒë·∫ßu (Initial Fetch)
      async function fetchInitialData() {
        try {
          // G·ªçi API l·∫•y t·ªìn kho
          const res = await fetch(
            "http://localhost:3000/api/inventory?store_id=1",
          );
          const json = await res.json();

          // T√¨m ƒë√∫ng s·∫£n ph·∫©m iPhone 15 Pro (ID=1)
          const product = json.data.find((p) => p.product_id === 1);

          if (product) {
            display.innerText = product.quantity;
          }
        } catch (err) {
          console.error("L·ªói l·∫•y d·ªØ li·ªáu:", err);
        }
      }

      // 2. Khi k·∫øt n·ªëi th√†nh c√¥ng -> G·ªçi h√†m l·∫•y d·ªØ li·ªáu ngay
      socket.on("connect", () => {
        statusLog.innerText = "üü¢ ƒê√£ k·∫øt n·ªëi t·ªõi Server!";
        fetchInitialData(); // <--- TH√äM D√íNG N√ÄY
      });

      // 3. L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi (Gi·ªØ nguy√™n)
      socket.on("STOCK_UPDATE", (data) => {
        console.log("Nh·∫≠n d·ªØ li·ªáu:", data);

        if (data.product_id == 1 && data.store_id == 1) {
          display.innerText = data.new_quantity;
          statusLog.innerText = `‚ö° ${new Date().toLocaleTimeString()}: ${data.message}`;

          // Hi·ªáu ·ª©ng c·∫£nh b√°o
          if (data.new_quantity < 5) {
            display.classList.add("blink");
            display.style.color = "red";
          } else {
            display.classList.remove("blink");
            display.style.color = "#2ecc71";
          }
        }
      });
    </script>
  </body>
</html>
